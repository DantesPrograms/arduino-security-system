<?xml version="1.0" encoding="UTF-8"?>
<circuit>
  <project>
    <n>Arduino R4 WiFi Security System</n>
    <version>1.2</version>
    <author>Dante D'Abramo</author>
    <date>2026-01-31</date>
    <description>Ultrasonic-Only Motion Detection Security System with Web Interface</description>
  </project>
  
  <board>
    <type>Arduino UNO R4 WiFi</type>
    <microcontroller>Renesas RA4M1</microcontroller>
    <wifi_module>ESP32-S3</wifi_module>
    <voltage>5V</voltage>
  </board>
  
  <components>
    <component id="1">
      <n>HC-SR04 Ultrasonic Sensor</n>
      <type>Distance measurement sensor</type>
      <voltage>5V DC</voltage>
      <current>15mA (typical)</current>
      <detection_range>2cm - 400cm</detection_range>
      <detection_angle>15 degrees</detection_angle>
      <notes>Primary and only motion detection sensor - measures distance changes</notes>
    </component>
    
    <component id="2">
      <n>Status LED</n>
      <type>3mm LED</type>
      <color>Any (Green recommended)</color>
      <forward_voltage>2.0V (typical)</forward_voltage>
      <forward_current>20mA (max)</forward_current>
      <notes>Indicates ARMED state</notes>
    </component>
    
    <component id="3">
      <n>Alarm LED</n>
      <type>5mm LED</type>
      <color>Red recommended</color>
      <forward_voltage>2.0V (typical)</forward_voltage>
      <forward_current>20mA (max)</forward_current>
      <notes>Indicates ALARM_TRIGGERED state</notes>
    </component>
    
    <component id="4">
      <n>Piezo Buzzer</n>
      <type>Active Buzzer</type>
      <voltage>5V DC</voltage>
      <current>30mA (typical)</current>
      <sound_level>85dB at 10cm</sound_level>
      <notes>Active type (generates tone internally)</notes>
    </component>
    
    <component id="5">
      <n>Resistor (Status LED)</n>
      <type>Through-hole resistor</type>
      <value>220Ω</value>
      <tolerance>5%</tolerance>
      <power_rating>1/4W</power_rating>
      <notes>Current limiting for Status LED</notes>
    </component>
    
    <component id="6">
      <n>Resistor (Alarm LED)</n>
      <type>Through-hole resistor</type>
      <value>220Ω</value>
      <tolerance>5%</tolerance>
      <power_rating>1/4W</power_rating>
      <notes>Current limiting for Alarm LED</notes>
    </component>
  </components>
  
  <connections>
    <!-- HC-SR04 Ultrasonic Sensor (Only Motion Detection) -->
    <connection id="1">
      <from>
        <component>HC-SR04 Ultrasonic</component>
        <pin>VCC</pin>
      </from>
      <to>
        <component>Arduino R4 WiFi</component>
        <pin>5V</pin>
      </to>
      <wire_color>Red</wire_color>
      <signal>Power</signal>
      <voltage>5V DC</voltage>
    </connection>
    
    <connection id="2">
      <from>
        <component>HC-SR04 Ultrasonic</component>
        <pin>GND</pin>
      </from>
      <to>
        <component>Arduino R4 WiFi</component>
        <pin>GND</pin>
      </to>
      <wire_color>Black</wire_color>
      <signal>Ground</signal>
      <voltage>0V</voltage>
    </connection>
    
    <connection id="3">
      <from>
        <component>HC-SR04 Ultrasonic</component>
        <pin>TRIG</pin>
      </from>
      <to>
        <component>Arduino R4 WiFi</component>
        <pin>D3</pin>
      </to>
      <wire_color>Blue</wire_color>
      <signal>Digital Output</signal>
      <voltage>0V/5V (logic level)</voltage>
      <direction>Output</direction>
      <notes>Triggers ultrasonic pulse</notes>
    </connection>
    
    <connection id="4">
      <from>
        <component>HC-SR04 Ultrasonic</component>
        <pin>ECHO</pin>
      </from>
      <to>
        <component>Arduino R4 WiFi</component>
        <pin>D4</pin>
      </to>
      <wire_color>Purple</wire_color>
      <signal>Digital Input</signal>
      <voltage>0V/5V (logic level)</voltage>
      <direction>Input</direction>
      <notes>Receives echo pulse for distance measurement</notes>
    </connection>
    
    <!-- Status LED (3mm) -->
    <connection id="5">
      <from>
        <component>Arduino R4 WiFi</component>
        <pin>D8</pin>
      </from>
      <to>
        <component>Resistor 220Ω (Status)</component>
        <pin>1</pin>
      </to>
      <wire_color>Green</wire_color>
      <signal>Digital Output</signal>
      <voltage>0V/5V (logic level)</voltage>
      <direction>Output</direction>
    </connection>
    
    <connection id="6">
      <from>
        <component>Resistor 220Ω (Status)</component>
        <pin>2</pin>
      </from>
      <to>
        <component>Status LED</component>
        <pin>Anode (+)</pin>
      </to>
      <wire_color>Green</wire_color>
      <signal>LED Current</signal>
      <current>~13.6mA</current>
    </connection>
    
    <connection id="7">
      <from>
        <component>Status LED</component>
        <pin>Cathode (-)</pin>
      </from>
      <to>
        <component>Arduino R4 WiFi</component>
        <pin>GND</pin>
      </to>
      <wire_color>Black</wire_color>
      <signal>Ground</signal>
      <voltage>0V</voltage>
    </connection>
    
    <!-- Alarm LED (5mm) -->
    <connection id="8">
      <from>
        <component>Arduino R4 WiFi</component>
        <pin>D9</pin>
      </from>
      <to>
        <component>Resistor 220Ω (Alarm)</component>
        <pin>1</pin>
      </to>
      <wire_color>Orange</wire_color>
      <signal>Digital Output</signal>
      <voltage>0V/5V (logic level)</voltage>
      <direction>Output</direction>
    </connection>
    
    <connection id="9">
      <from>
        <component>Resistor 220Ω (Alarm)</component>
        <pin>2</pin>
      </from>
      <to>
        <component>Alarm LED</component>
        <pin>Anode (+)</pin>
      </to>
      <wire_color>Orange</wire_color>
      <signal>LED Current</signal>
      <current>~13.6mA</current>
    </connection>
    
    <connection id="10">
      <from>
        <component>Alarm LED</component>
        <pin>Cathode (-)</pin>
      </from>
      <to>
        <component>Arduino R4 WiFi</component>
        <pin>GND</pin>
      </to>
      <wire_color>Black</wire_color>
      <signal>Ground</signal>
      <voltage>0V</voltage>
    </connection>
    
    <!-- Piezo Buzzer -->
    <connection id="11">
      <from>
        <component>Arduino R4 WiFi</component>
        <pin>D10</pin>
      </from>
      <to>
        <component>Piezo Buzzer</component>
        <pin>Positive (+)</pin>
      </to>
      <wire_color>White</wire_color>
      <signal>Digital Output</signal>
      <voltage>0V/5V (logic level)</voltage>
      <direction>Output</direction>
      <notes>Pulsing pattern: 500ms on/off</notes>
    </connection>
    
    <connection id="12">
      <from>
        <component>Piezo Buzzer</component>
        <pin>Negative (-)</pin>
      </from>
      <to>
        <component>Arduino R4 WiFi</component>
        <pin>GND</pin>
      </to>
      <wire_color>Black</wire_color>
      <signal>Ground</signal>
      <voltage>0V</voltage>
    </connection>
  </connections>
  
  <pin_summary>
    <pin name="D3" type="OUTPUT" function="Ultrasonic TRIG (Trigger pulse)" />
    <pin name="D4" type="INPUT" function="Ultrasonic ECHO (Distance measurement)" />
    <pin name="D8" type="OUTPUT" function="Status LED Control (via 220Ω)" />
    <pin name="D9" type="OUTPUT" function="Alarm LED Control (via 220Ω)" />
    <pin name="D10" type="OUTPUT" function="Buzzer Control" />
    <pin name="5V" type="POWER" function="Power Supply for all components" />
    <pin name="GND" type="GROUND" function="Common ground for all components" />
    <pin name="D2" type="UNUSED" function="Available for future expansion" />
  </pin_summary>
  
  <power_analysis>
    <total_current>
      <maximum>58.2mA</maximum>
      <typical>42mA</typical>
      <notes>Assumes all outputs active simultaneously - PIR removed</notes>
    </total_current>
    
    <breakdown>
      <component name="HC-SR04 Ultrasonic">
        <current>15mA</current>
        <notes>Typical operating current</notes>
      </component>
      <component name="Status LED">
        <current>13.6mA</current>
        <calculation>(5V - 2V) / 220Ω = 13.6mA</calculation>
      </component>
      <component name="Alarm LED">
        <current>13.6mA</current>
        <calculation>(5V - 2V) / 220Ω = 13.6mA</calculation>
      </component>
      <component name="Piezo Buzzer">
        <current>30mA</current>
        <notes>Typical for active buzzer</notes>
      </component>
    </breakdown>
    
    <comparison>
      <previous_version>v1.1 with PIR: 123.2mA max</previous_version>
      <current_version>v1.2 ultrasonic only: 58.2mA max</current_version>
      <savings>65mA reduction (53% less power consumption)</savings>
    </comparison>
    
    <gpio_current>
      <total>57.2mA</total>
      <per_pin_limit>8mA (recommended), 20mA (absolute max)</per_pin_limit>
      <status>WARNING: LEDs exceed 8mA recommendation</status>
      <recommendation>Current design is within absolute maximum ratings but exceeds recommended levels. Consider using transistors for switching if concerned about long-term reliability.</recommendation>
    </gpio_current>
  </power_analysis>
  
  <detection_system>
    <sensor>
      <n>HC-SR04 Ultrasonic</n>
      <method>Distance-based motion detection</method>
      <advantages>
        - No heat sensitivity (eliminates PIR false alarms)
        - Measures actual distance changes
        - More reliable for indoor use
        - Adjustable detection range and sensitivity
        - Simpler system with single sensor
        - Lower power consumption
      </advantages>
      <configuration>
        - Detection range: 150cm (configurable)
        - Movement threshold: 30cm change (configurable)
        - Check interval: 500ms
      </configuration>
    </sensor>
    
    <detection_logic>
      System arms with ultrasonic baseline measurement.
      Continuously monitors for distance changes when ARMED.
      Triggers alarm when distance change exceeds threshold.
      No backup sensor - simplified, reliable detection.
    </detection_logic>
    
    <why_no_pir>
      PIR sensor removed in v1.2 due to:
      - Frequent false alarms from heat sources
      - Sensitivity to sunlight and temperature changes
      - Required constant calibration and adjustment
      - Added complexity without significant benefit
      Ultrasonic sensor alone provides superior reliability.
    </why_no_pir>
  </detection_system>
  
  <assembly_notes>
    <note priority="high">
      Verify LED polarity before connecting. Longer leg is anode (+), shorter leg is cathode (-).
    </note>
    <note priority="high">
      Point HC-SR04 ultrasonic sensor toward main detection area (room entrance).
    </note>
    <note priority="medium">
      Keep ultrasonic sensor clear of obstacles - nothing should block TRIG/ECHO cylinders.
    </note>
    <note priority="medium">
      Mount sensor level (not tilted) for accurate distance measurements.
    </note>
    <note priority="medium">
      Active buzzer has polarity. Connect positive terminal to D10, negative to GND.
    </note>
    <note priority="low">
      Use color-coded jumper wires for easier troubleshooting and maintenance.
    </note>
    <note priority="low">
      Consider using a breadboard for initial prototyping before permanent installation.
    </note>
    <note priority="info">
      Pin D2 is now unused and available for future expansion (v1.1 used it for PIR).
    </note>
  </assembly_notes>
  
  <testing_procedure>
    <step number="1">
      Connect all components according to pin diagram without powering on
    </step>
    <step number="2">
      Double-check all connections, especially power and ground
    </step>
    <step number="3">
      Upload firmware to Arduino R4 WiFi via USB-C
    </step>
    <step number="4">
      Open Serial Monitor at 115200 baud
    </step>
    <step number="5">
      Verify WiFi connection and note IP address
    </step>
    <step number="6">
      ARM system via web interface - note baseline distance in Serial Monitor
    </step>
    <step number="7">
      Test ultrasonic: Move hand slowly in front of sensor (within 1.5m)
    </step>
    <step number="8">
      Verify Alarm LED and Buzzer activate
    </step>
    <step number="9">
      Disarm system via web interface to stop alarm
    </step>
    <step number="10">
      Test from different distances and angles to verify coverage
    </step>
  </testing_procedure>
  
  <tuning_parameters>
    <ultrasonic>
      <parameter name="DETECTION_DISTANCE">
        <default>150</default>
        <unit>centimeters</unit>
        <description>Maximum range for detection (default 150cm = 5 feet)</description>
        <tuning>Decrease for smaller rooms (e.g., 100cm), increase for larger spaces (e.g., 200cm)</tuning>
      </parameter>
      <parameter name="DISTANCE_CHANGE_THRESHOLD">
        <default>30</default>
        <unit>centimeters</unit>
        <description>Minimum distance change to trigger (default 30cm)</description>
        <tuning>Increase to reduce sensitivity (e.g., 50cm), decrease for more sensitive detection (e.g., 20cm)</tuning>
      </parameter>
      <parameter name="DISTANCE_CHECK_INTERVAL">
        <default>500</default>
        <unit>milliseconds</unit>
        <description>How often to check distance (default 500ms)</description>
        <tuning>Lower values = faster response but more processing (e.g., 250ms), higher = less frequent checks (e.g., 1000ms)</tuning>
      </parameter>
    </ultrasonic>
  </tuning_parameters>
  
  <troubleshooting>
    <issue>
      <problem>Ultrasonic sensor not detecting</problem>
      <solutions>
        - Verify TRIG on D3 and ECHO on D4
        - Ensure 5V power to sensor
        - Check Serial Monitor for baseline distance when arming
        - Point sensor toward open space (not wall or obstacle)
        - Adjust DETECTION_DISTANCE or DISTANCE_CHANGE_THRESHOLD
        - Ensure nothing is blocking the sensor cylinders
      </solutions>
    </issue>
    
    <issue>
      <problem>Too many false alarms</problem>
      <solutions>
        - Increase DISTANCE_CHANGE_THRESHOLD (e.g., 50cm)
        - Point sensor away from curtains, fans, or moving objects
        - Secure sensor mounting to prevent vibrations
        - Decrease DETECTION_DISTANCE to reduce range
      </solutions>
    </issue>
    
    <issue>
      <problem>Sensor misses motion</problem>
      <solutions>
        - Decrease DISTANCE_CHANGE_THRESHOLD for more sensitivity
        - Increase DETECTION_DISTANCE for longer range
        - Ensure sensor is pointed at main traffic area
        - Check that movement is within sensor's 15-degree cone
      </solutions>
    </issue>
  </troubleshooting>
  
  <safety_warnings>
    <warning type="electrical">
      Do not exceed GPIO current limits. Each pin is rated for maximum 8mA continuous (20mA absolute max).
    </warning>
    <warning type="electrical">
      Ensure proper current-limiting resistors are used for LEDs to prevent damage.
    </warning>
    <warning type="electrical">
      Never connect components directly to mains voltage. System operates at 5V DC only.
    </warning>
    <warning type="operational">
      This is an educational/demonstration project. Not suitable for critical security applications.
    </warning>
    <warning type="operational">
      Ultrasonic sensor has narrow 15-degree detection angle - position carefully for full room coverage.
    </warning>
  </safety_warnings>
  
  <advantages_v1_2>
    <advantage>Simpler wiring (4 fewer connections than v1.1)</advantage>
    <advantage>Lower cost (~$3 savings without PIR)</advantage>
    <advantage>53% less power consumption (58mA vs 123mA)</advantage>
    <advantage>No heat-based false alarms</advantage>
    <advantage>Easier troubleshooting (single sensor)</advantage>
    <advantage>More reliable detection</advantage>
    <advantage>No PIR warm-up wait time</advantage>
    <advantage>Cleaner, more maintainable code</advantage>
  </advantages_v1_2>
  
  <revision_history>
    <revision version="1.2" date="2026-01-31">
      MAJOR CHANGE: Removed PIR sensor - ultrasonic only system
      Simplified to single-sensor architecture
      Reduced component count from 7 to 6
      Lower power consumption (58mA vs 123mA)
      Cleaner code without PIR debouncing logic
      Pin D2 now available for future expansion
    </revision>
    <revision version="1.1" date="2026-01-31">
      Added HC-SR04 ultrasonic sensor as primary motion detection
      PIR sensor as backup with smart filtering
      Dual-sensor architecture for improved reliability
      AJAX-powered web interface
    </revision>
    <revision version="1.0" date="2026-01-30">
      Initial release - Basic security system with PIR, LEDs, buzzer, and web interface
    </revision>
  </revision_history>
</circuit>
